##########################################################################################

# Ce document contient la configuration des différents services HSS, MME SPGW-C et SPGW-U

##########################################################################################

#   ---
#   Les variables utilisées dans la configuration
#   ---

Cassandra_Server_IP='127.0.0.1'
MY_REALM='epc.org'
PREFIX='/usr/local/etc/oai'

##########################################################################################

#   ---
#   Configuration des différentes interfaces
#   ---

sudo ifconfig ens19:m1c 192.168.247.102 up     # interface @:mme vers l'interface du @eNB
sudo ifconfig ens19:m11 192.168.1.102 up     # interface @:mme vers @:sgw-c

sudo ifconfig ens19:sxu 192.168.55.102 up    # interface @:spgw-u vers interface @:pgw-c
sudo ifconfig ens19:s1u 192.168.248.159 up    # interface @:spgw-u vers interface @eNB

sudo ifconfig ens19:sxc 192.168.55.101 up    # interface @:pgw-c vers interface @:spgw-u
sudo ifconfig ens19:s5c 192.168.58.102 up    # interface @:sgw-c vers interface @:pgw-c
sudo ifconfig ens19:p5c 192.168.58.101 up    # interface @:pgw-c vers interface @:sgw-c
sudo ifconfig ens19:s11 192.168.1.104 up     # interface @:sgw-c vers interface @:mme

echo '200 lte' | sudo tee --append /etc/iproute2/rt_tables
sudo ip r add default via 172.25.25.1 dev eth2 table lte
sudo ip rule add from 172.25.0.0/16 table lte

##########################################################################################

#   ---
#       Configuration du HSS
#   ---

##########################################################################################

openssl rand -out $HOME/.rnd 128

cd ~/openair-cn/scripts

sudo mkdir -m 0777 -p $PREFIX
sudo chmod 777 $PREFIX
sudo mkdir -m 0777 -p $PREFIX/freeDiameter
sudo mkdir -m 0777 -p $PREFIX/logs
sudo mkdir -m 0777 -p logs

cp ../etc/acl.conf ../etc/hss_rel14_fd.conf $PREFIX/freeDiameter
cp ../etc/hss_rel14.conf ../etc/hss_rel14.json $PREFIX
cp ../etc/oss.json $PREFIX

declare -A HSS_CONF
HSS_CONF[@PREFIX@]=$PREFIX
HSS_CONF[@REALM@]=$MY_REALM
HSS_CONF[@HSS_FQDN@]="hss.${HSS_CONF[@REALM@]}"
HSS_CONF[@cassandra_Server_IP@]=$Cassandra_Server_IP
HSS_CONF[@OP_KEY@]='11111111111111111111111111111111'
HSS_CONF[@ROAMING_ALLOWED@]='true'
for K in "${!HSS_CONF[@]}"; do egrep -lRZ "$K" $PREFIX | xargs -0 -l sed -i -e "s|$K|${HSS_CONF[$K]}|g"; done
sed -i -e 's/#ListenOn/ListenOn/g' $PREFIX/freeDiameter/hss_rel14_fd.conf
../src/hss_rel14/bin/make_certs.sh hss ${HSS_CONF[@REALM@]} $PREFIX
pushd $PREFIX
sudo oai_hss -j $PREFIX/hss_rel14.json --onlyloadkey
popd

##########################################################################################

#   ---
#       Configuration du MME
#   ---

cd ~/openair-cn/scripts

sudo mkdir -m 0777 -p $PREFIX
sudo chmod 777 $PREFIX
sudo mkdir -m 0777 -p $PREFIX/freeDiameter


INSTANCE=1
cp ../etc/mme_fd.sprint.conf $PREFIX/freeDiameter/mme_fd.conf
cp ../etc/mme.conf $PREFIX

declare -A MME_CONF

MME_CONF[@MME_S6A_IP_ADDR@]="127.0.0.11"
MME_CONF[@INSTANCE@]=$INSTANCE
MME_CONF[@PREFIX@]=$PREFIX
MME_CONF[@REALM@]=$MY_REALM
MME_CONF[@PID_DIRECTORY@]='/var/run'
MME_CONF[@MME_FQDN@]="mme.${MME_CONF[@REALM@]}"
MME_CONF[@HSS_HOSTNAME@]='hss'
MME_CONF[@HSS_FQDN@]="${MME_CONF[@HSS_HOSTNAME@]}.${MME_CONF[@REALM@]}"
MME_CONF[@HSS_IP_ADDR@]=$Cassandra_Server_IP

# HERE I HAVE THE CORRECT MCC / NNC
MME_CONF[@MCC@]='208'
MME_CONF[@MNC@]='95'
MME_CONF[@MME_GID@]='32768'
MME_CONF[@MME_CODE@]='3'
MME_CONF[@TAC_0@]='600'
MME_CONF[@TAC_1@]='601'
MME_CONF[@TAC_2@]='602'

# ALL SUB NETWORK INTERFACES ARE ens19 BASED
# S1 will be the 1st interface to be reached by an eNB --> on ens19 and 192.168.3.17 is the IP address on ens19
MME_CONF[@MME_INTERFACE_NAME_FOR_S1_MME@]='ens19:m1c'
MME_CONF[@MME_IPV4_ADDRESS_FOR_S1_MME@]='192.168.247.102/24'
MME_CONF[@MME_INTERFACE_NAME_FOR_S11@]='ens19:m11'
MME_CONF[@MME_IPV4_ADDRESS_FOR_S11@]='192.168.1.102/24'
MME_CONF[@MME_INTERFACE_NAME_FOR_S10@]='ens19:m10'
MME_CONF[@MME_IPV4_ADDRESS_FOR_S10@]='192.168.10.110/24'
MME_CONF[@OUTPUT@]='CONSOLE'
MME_CONF[@SGW_IPV4_ADDRESS_FOR_S11_TEST_0@]='192.168.1.104/24'
MME_CONF[@SGW_IPV4_ADDRESS_FOR_S11_0@]='192.168.1.104/24'
MME_CONF[@PEER_MME_IPV4_ADDRESS_FOR_S10_0@]='0.0.0.0/24'
MME_CONF[@PEER_MME_IPV4_ADDRESS_FOR_S10_1@]='0.0.0.0/24'
# the rest is the same in Lionel setup
TAC_SGW_TEST='7'
tmph=`echo "$TAC_SGW_TEST / 256" | bc`
tmpl=`echo "$TAC_SGW_TEST % 256" | bc`
MME_CONF[@TAC-LB_SGW_TEST_0@]=`printf "%02x\n" $tmpl`
MME_CONF[@TAC-HB_SGW_TEST_0@]=`printf "%02x\n" $tmph`
MME_CONF[@MCC_SGW_0@]=${MME_CONF[@MCC@]}
MME_CONF[@MNC3_SGW_0@]=`printf "%03d\n" $(echo ${MME_CONF[@MNC@]} | sed 's/^0*//')`
TAC_SGW_0='600'
tmph=`echo "$TAC_SGW_0 / 256" | bc`
tmpl=`echo "$TAC_SGW_0 % 256" | bc`
MME_CONF[@TAC-LB_SGW_0@]=`printf "%02x\n" $tmpl`
MME_CONF[@TAC-HB_SGW_0@]=`printf "%02x\n" $tmph`
MME_CONF[@MCC_MME_0@]=${MME_CONF[@MCC@]}
MME_CONF[@MNC3_MME_0@]=`printf "%03d\n" $(echo ${MME_CONF[@MNC@]} | sed 's/^0*//')`
TAC_MME_0='601'
tmph=`echo "$TAC_MME_0 / 256" | bc`
tmpl=`echo "$TAC_MME_0 % 256" | bc`
MME_CONF[@TAC-LB_MME_0@]=`printf "%02x\n" $tmpl`
MME_CONF[@TAC-HB_MME_0@]=`printf "%02x\n" $tmph`
MME_CONF[@MCC_MME_1@]=${MME_CONF[@MCC@]}
MME_CONF[@MNC3_MME_1@]=`printf "%03d\n" $(echo ${MME_CONF[@MNC@]} | sed 's/^0*//')`
TAC_MME_1='602'
tmph=`echo "$TAC_MME_1 / 256" | bc`
tmpl=`echo "$TAC_MME_1 % 256" | bc`
MME_CONF[@TAC-LB_MME_1@]=`printf "%02x\n" $tmpl`
MME_CONF[@TAC-HB_MME_1@]=`printf "%02x\n" $tmph`
for K in "${!MME_CONF[@]}"; do    egrep -lRZ "$K" $PREFIX | xargs -0 -l sed -i -e "s|$K|${MME_CONF[$K]}|g";   ret=$?;[[ ret -ne 0 ]] && echo "Tried to replace $K with ${MME_CONF[$K]}"; done
sudo ./check_mme_s6a_certificate $PREFIX/freeDiameter mme.${MME_CONF[@REALM@]}

##########################################################################################

#   ---
#       Configuration du SPGW-U
#   ---

cd $HOME/openair-cn-cups/build/scripts

INSTANCE=1
sudo mkdir -m 0777 -p $PREFIX
sudo chmod 777 $PREFIX
cp ../../etc/spgw_u.conf $PREFIX​

declare -A SPGWU_CONF
SPGWU_CONF[@INSTANCE@]=$INSTANCE
SPGWU_CONF[@PID_DIRECTORY@]='/var/run'
SPGWU_CONF[@SGW_INTERFACE_NAME_FOR_S1U_S12_S4_UP@]='ens19:s1u'
SPGWU_CONF[@SGW_INTERFACE_NAME_FOR_SX@]='ens19:sxu'
SPGWU_CONF[@SGW_INTERFACE_NAME_FOR_SGI@]='eth2'

for K in "${!SPGWU_CONF[@]}"; do   egrep -lZ "$K" $PREFIX/spgw_u.conf | xargs -0 -l sed -i -e "s|$K|${SPGWU_CONF[$K]}|g"; ret=$?;[[ ret -ne 0 ]] && echo "Tried to replace $K with ${SPGWU_CONF[$K]}"; done

#   ---
#       Configuration du fichier /usr/local//spgw_u.conf
#   ---

    PDN_NETWORK_LIST  = (
                      {NETWORK_IPV4 = "172.25.25.0/24"; NETWORK_IPV6 = "2001:1:2::0/64"; SNAT = "yes";}
                    );

    SPGW-C_LIST = (
         {IPV4_ADDRESS="192.168.55.101" ;}
    );

##########################################################################################

#   ---
#       Configuration du SPGW-C
#   ---

cd $HOME/openair-cn-cups/build/scripts

INSTANCE=1

sudo mkdir -m 0777 -p $PREFIX
sudo chmod 777 $PREFIX
cp ../../etc/spgw_c.conf $PREFIX

declare -A SPGWC_CONF

SPGWC_CONF[@INSTANCE@]=$INSTANCE
SPGWC_CONF[@PID_DIRECTORY@]='/var/run'
SPGWC_CONF[@SGW_INTERFACE_NAME_FOR_S11@]='ens19:s11'
SPGWC_CONF[@SGW_INTERFACE_NAME_FOR_S5_S8_CP@]='ens19:s5c'
SPGWC_CONF[@PGW_INTERFACE_NAME_FOR_S5_S8_CP@]='ens19:p5c'
SPGWC_CONF[@PGW_INTERFACE_NAME_FOR_SX@]='ens19:sxc'
SPGWC_CONF[@DEFAULT_DNS_IPV4_ADDRESS@]='8.8.8.8'
SPGWC_CONF[@DEFAULT_DNS_SEC_IPV4_ADDRESS@]='4.4.4.4'

for K in "${!SPGWC_CONF[@]}"; do egrep -lZ "$K" $PREFIX/spgw_c.conf | xargs -0 -l sed -i -e "s|$K|${SPGWC_CONF[$K]}|g"; ret=$?;[[ ret -ne 0 ]] && echo "Tried to replace $K with ${SPGWC_CONF[$K]}"; done

#   ---
#       Configuration du fichier /usr/local//spgw_c.conf
#   ---

    IP_ADDRESS_POOL :
    {
        IPV4_LIST = (
                      {RANGE = "172.25.25.130 - 172.25.25.150";},                          # STRING, IPv4 RANGE IP_start - IP_end, YOUR NETWORK CONFIG HERE.
                      {RANGE = "172.25.25.170 - 172.25.25.190";}                           # STRING, IPv4 RANGE IP_start - IP_end, YOUR NETWORK CONFIG HERE.
                    );
        IPV6_LIST = (
                      {PREFIX = "2001:1:2::/64";}                                          # STRING, IPv6 prefix, YOUR NETWORK CONFIG HERE.
                    );
    };

    APN_LIST = (
       # IPV4_POOL, IPV6_POOL are index in IPV4_LIST, IPV6_LIST, PDN_TYPE choice in {IPv4, IPv6, IPv4v6}
      {APN_NI = "oai.ipv4"; PDN_TYPE = "IPv4"; IPV4_POOL  = 0; IPV6_POOL = -1},
      {APN_NI = "internet"; PDN_TYPE = "IPv4"; IPV4_POOL = 1; IPV6_POOL = -1}
    );

##########################################################################################